<ion-view id="pg_booking" view-title="Select Pick-up and Drop-off Points">
  <ion-content class="fullscreen-map" has-bouncing="false">
  <div class="route-info">
    <route-item route="book.route"></route-item>

    <div class="price">
      <div class="from">
        from
      </div>
      <fancy-price value="book.route.trips[0].price"></fancy-price>
    </div>
  </div>

  <ui-gmap-google-map
    center="map.center"
    zoom="map.zoom"
    bounds="map.bounds"
    control="map.control"
    options="map.options"
    data-tap-disabled="true"
    >
    <ui-gmap-marker
      ng-repeat="stop in book.boardStops"
      idKey="stop.id"
      coords="{
        latitude: stop.coordinates.coordinates[1],
        longitude: stop.coordinates.coordinates[0],
      }"
      options="map.markerOptions.boardMarker"
      click="applyTapBoard(stop)"
    ></ui-gmap-marker>
    <ui-gmap-marker
      ng-repeat="stop in book.alightStops"
      idKey="stop.id"
      coords="{
        latitude: stop.coordinates.coordinates[1],
        longitude: stop.coordinates.coordinates[0],
      }"
      options="map.markerOptions.alightMarker"
      click="applyTapAlight(stop)"
    ></ui-gmap-marker>

    <ui-gmap-polyline
      path="routePath"
      stroke="{
        color: '#4b3863',
        weight: 3.0,
      }"
    >
    </ui-gmap-polyline>

    <ui-gmap-window
      ng-if="infoStop"
      show="infoStop"
      coords="{
        latitude: infoStop.coordinates.coordinates[1],
        longitude: infoStop.coordinates.coordinates[0],
      }"
      >
      <div class="booking-stops-infowindow">
        <b>{{infoStop.time | formatTime}}</b><br/>
        {{infoStop.description}}
        <br>{{infoStop.label}}
        <br>{{infoStop.road}}
        <br/>
        <button onclick="setStop()">
        Select {{infoType == 'board'? 'pick-up' : 'drop-off'}} stop
        </button>
      </div>
    </ui-gmap-window>
  </ui-gmap-google-map>

  <div id="userpos" ng-click="getUserLocation()"></div>

  <ion-list class="stop-inputs">
    <bus-stop-selector
      model="book.boardStop"
      bus-stops="book.boardStops"
      value="getStopId"
      display="getStopDescription"
      display2="getStopDescription2"
      placeholder="{{book.stxt}}"
      title="{{book.stxt}}"
      button="{{book.stxt}}"
      marker-options="map.markerOptions.boardMarker"
      pin-options="map.markerOptions.startMarker"
      >
    </bus-stop-selector>
    <div class="line"></div>
    <bus-stop-selector
      model="book.alightStop"
      bus-stops="book.alightStops"
      value="getStopId"
      display="getStopDescription"
      display2="getStopDescription2"
      placeholder="{{book.etxt}}"
      title="{{book.etxt}}"
      button="{{book.etxt}}"
      marker-options="map.markerOptions.alightMarker"
      pin-options="map.markerOptions.endMarker"
      >
    </bus-stop-selector>
    <div class="item">
      Number of Passengers
      <qty-input
        placeholder="{{book.ptxt}}"
        ng-model="book.qty"
        class="item-note"
        >
      </qty-input>
    </div>
  </ion-list>

  <div class="item button-bar">
    <button class="button big-yellow big-yellow-centered"
      ui-sref="tabs.booking-dates({
        routeId: book.routeId,
        boardStop: book.boardStop,
        alightStop: book.alightStop
      })"
      ng-disabled="!book.alightStop || !book.boardStop || !book.qty">
      Continue
    </button>
  </div>
  </ion-content>

  <script id="changes-message.html" type="text/ng-template">
    <div id="changes-message" class="modal">
      <ion-header-bar class="bar-stable">
          <h1 class="title">Changes to Service #{{book.routeid}}</h1>
        <a class="item-icon-right" ng-click="closeChangesModal()">
          <i class="icon ion-android-close"></i>
        </a>
      </ion-header-bar>
      <ion-content>
        <table class="route-changes-table">
          <thead>
            <tr>
              <th><!--icon--></th>
              <th>Date</th>
              <th>Changes</th>
            </tr>
          </thead>
          <tbody>
              <tr ng-repeat="priceChange in book.changes.priceChanges">
              <td>$$</td>
              <td>
                {{priceChange.startDate | formatDate}}
              </td>
              <td>
                {{priceChange.humanReadable[0]}}
              </td>
            </tr>
              <tr ng-repeat="stopChange in book.changes.stopChanges">
              <td>S</td>
              <td>
                {{stopChange.startDate | formatDate}}
              </td>
              <td>
                <ul>
                  <li ng-repeat="hr in stopChange.humanReadable track by $index">
                {{hr}}
                </li>
                </ul>
              </td>
            </tr>
              <tr ng-repeat="timeChange in book.changes.timeChanges">
              <td>T</td>
              <td>
                {{timeChange.startDate | formatDate}}
              </td>
              <td>
                <ul>
                  <li ng-repeat="hr in timeChange.humanReadable track by $index">
                {{hr}}
                </li>
                </ul>
              </td>
            </tr>
          </tbody>
        </table>
      </ion-content>
    </div>
  </script>
</ion-view>
