<ion-view class="routes-view">

  <!-- Search Filter  -->
  <label class="search item item-input">
    <i class="icon ion-ios-search-strong"></i>
    <input
      id="search"
      type="text"
      ng-model="data.queryText"
      placeholder="Search Routes"
    />
    <i
      class="icon ion-android-close"
      on-tap="data.queryText = ''"
      ng-show="data.queryText.length > 0"
    ></i>
  </label>

  <!-- Scrollable routes list -->
  <ion-content class="routes-scroll">

    <ion-refresher
      pulling-text="Pull to refresh..."
      on-refresh="refreshRoutes(true)"
    ></ion-refresher>

    <ion-list>
      <!-- Error message if problem getting routes data -->
      <div class="item item-text-wrap" ng-if="error">
        <i class="icon ion-alert-circled"></i>
        There was a problem fetching the routes from the server.
        Please try again later and let us know at feedback@beeline.sg if the problem persists.
      </div>

      <!-- Recent Routes Section -->
      <div
        class="item item-divider"
        ng-if="data.activatedCrowdstartRoutes &&
               data.activatedCrowdstartRoutes.length > 0"
      >
        Activated Crowdstart Routes
      </div>
      <ion-item
        ng-repeat="route in data.activatedCrowdstartRoutes"
        ui-sref="tabs.bookingPickup({
          routeId: route.id,
          boardStop:  data.recentRoutesById[route.id].boardStopStopId,
          alightStop: data.recentRoutesById[route.id].alightStopStopId,
          sessionId: data.nextSessionId,
        })"
        ng-if="data.activatedCrowdstartRoutes &&
               data.activatedCrowdstartRoutes.length > 0"
        class="item-icon-right"
      >
        <regular-route route="route"></regular-route>
        <i class="icon ion-ios-arrow-right"></i>
      </ion-item>

      <!-- Recently booked routes -->
      <div class="item item-divider" ng-if="data.recentRoutes.length > 0">
        Recently Booked Routes
      </div>
      <ion-item
        ng-repeat="route in data.recentRoutes"
        ui-sref="tabs.bookingPickup({
          routeId: route.id,
          boardStop:  data.recentRoutesById[route.id].boardStopStopId,
          alightStop: data.recentRoutesById[route.id].alightStopStopId,
          sessionId: data.nextSessionId,
        })"
        class="item-text-wrap item-icon-right"
      >
        <regular-route route="route"></regular-route>
        <i class="icon ion-ios-arrow-right"></i>
      </ion-item>

      <!-- Backed Crowdstart Routes -->
      <div
        class="item item-divider"
        ng-if="data.backedCrowdstartRoutes.length > 0"
      >
        Your Crowdstart Pre-orders
      </div>
      <ion-item
        ng-repeat="route in data.backedCrowdstartRoutes"
        class="item-text-wrap item-icon-right"
        ui-sref="tabs.crowdstart-recap({ routeId: route.id })">
        <kickstart-route route="route"></kickstart-route>
        <i class="icon ion-ios-arrow-right"></i>
      </ion-item>

      <!-- Available Routes Section -->
      <div
        class="item item-divider"
        ng-if="data.liteRoutes.length > 0 || data.routes.length > 0"
      >
        Available Routes
      </div>
      <ion-item
        ng-repeat="route in data.routes"
        ui-sref="tabs.bookingPickup({
          routeId: route.id,
          sessionId: data.nextSessionId,
        })"
        class="item-text-wrap item-icon-right"
      >
        <regular-route route="route"></regular-route>
        <i class="icon ion-ios-arrow-right"></i>
      </ion-item>

      <!-- Available Lite Routes Section -->
      <ion-item
        ng-repeat="route in data.liteRoutes"
        ui-sref="tabs.lite-summary({ label: route.label })"
        class="item-icon-right"
      >
        <lite-route route="route"></lite-route>
        <i class="icon ion-ios-arrow-right"></i>
      </ion-item>

      <!-- Available Crowdstart Routes -->
      <div
        class="item item-divider"
        ng-if="data.crowdstartRoutes.length &&
               data.crowdstartRoutes.length > 0"
      >
        Crowdstart Routes
      </div>
      <ion-item
        ng-repeat="route in data.crowdstartRoutes"
        class="item-text-wrap item-icon-right"
        ui-sref="tabs.crowdstart-detail({ routeId: route.id })"
      >
        <!-- TODO - refactor this into a directive -->
        <route-item>
          <route-item-bus-number>
            {{ route.label }}
          </route-item-bus-number>
          <route-item-description>
            {{ route.notes.description }}
          </route-item-description>
          <route-item-start-time>
            {{ route | routeStartTime | formatTime:true }}
          </route-item-start-time>
          <route-item-start-location>
            {{ route.from }}
          </route-item-start-location>
          <route-item-end-time>
            {{ route | routeEndTime | formatTime:true }}
          </route-item-end-time>
          <route-item-end-location>
            {{ route.to }}
          </route-item-end-location>
          <route-item-additional-info>
            <company-info-broker company-id="route.transportCompanyId" company="companyInfo">
            </company-info-broker>
            <div class="icon-and-schedule">
              <span class="icon-span company-logo">
                  <img class="mini-icon" ng-src="{{route.transportCompanyId | companyLogo}}">
                </span>
              <span class="mini-info">
                  {{companyInfo.name}}
                </span>
            </div>

            <div class="icon-and-schedule">
              <span class="icon-span">
                  <img class="mini-icon" src="img/icon_kickstarter_timeleft.svg">
                </span>
              <span class="mini-info" ng-if="route.daysLeft && route.daysLeft>1">
                  Campaign ends in {{route.daysLeft}} days
                </span>
              <span class="mini-info" ng-if="route.daysLeft && route.daysLeft==1">
                  Campaign ends in  {{route.daysLeft}} day
                </span>
              <span class="mini-info" ng-if="route.isExpired">
                  Campaign has expired
                </span>
            </div>

            <progress-bar backer1="route.notes.tier[0].count " price1="route.notes.tier[0].price" pax1="route.notes.tier[0].pax" needed="route.notes.tier[0].moreNeeded">
            </progress-bar>

            <div class="icon-and-schedule">
              <span class="icon-span">
                  <img class="mini-icon" src="img/icon_kickstarter_status.svg">
                </span>
              <span class="mini-info">
                  {{route.status}}
                </span>
            </div>
          </route-item-additional-info>
        </route-item>
        <i class="icon ion-ios-arrow-right"></i>
      </ion-item>
    </ion-list>

    <powered-by-beeline></powered-by-beeline>

    <!-- No results found message -->
    <p
      ng-if="data.routes.length === 0 &&
            data.liteRoutes.length === 0 &&
            data.crowdstartRoutes.length === 0 &&
            data.placeQuery"
      class="not-found-message text-center"
    >
      Sorry, we could not find any routes matching "{{data.queryText}}".
    </p>
  </ion-content>

</ion-view>
